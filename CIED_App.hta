<html>
<head>
<title>CIEDs Patient Management System</title>
<HTA:APPLICATION
    ID="CIEDApp"
    APPLICATIONNAME="CIEDsSystem"
    BORDER="thick"
    BORDERSTYLE="normal"
    CAPTION="yes"
    ICON=""
    MAXIMIZEBUTTON="yes"
    MINIMIZEBUTTON="yes"
    SHOWINTASKBAR="yes"
    SINGLEINSTANCE="yes"
    SYSMENU="yes"
    VERSION="3.1"
    WINDOWSTATE="maximize"
    NAVIGABLE="yes"
/>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta charset="Shift_JIS">
<style>
/* Reset & Base */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: 'Meiryo', 'Segoe UI', sans-serif; 
    background-color: #f8fafc; 
    color: #333; 
    height: 100vh; 
    width: 100vw;
    overflow: hidden; 
}
button, input, select, textarea { font-family: inherit; }

/* Layout */
#sidebar-panel {
    position: absolute;
    top: 0; left: 0; bottom: 0;
    width: 320px;
    background-color: #1e293b;
    border-right: 1px solid #475569;
    z-index: 10;
    display: flex;
    flex-direction: column;
}
#main-panel {
    position: absolute;
    top: 0; left: 320px; right: 0; bottom: 0;
    background-color: #f8fafc;
    display: flex;
    flex-direction: column;
}

/* Sidebar Elements */
.sidebar-header {
    height: 50px;
    background-color: #0f172a;
    display: flex;
}
.sidebar-tab {
    flex: 1;
    background: transparent;
    color: #94a3b8;
    border: none;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
}
.sidebar-tab:hover { background: rgba(255,255,255,0.05); }
.sidebar-tab.active {
    color: #fff;
    background: #1e293b;
    border-bottom: 3px solid #3b82f6;
}

.sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    display: none;
}
.sidebar-content.active { display: block; }

.search-box {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    background: #334155;
    border: 1px solid #475569;
    color: #fff;
    border-radius: 4px;
}

.patient-list-item {
    padding: 12px;
    border-bottom: 1px solid #334155;
    cursor: pointer;
    transition: background 0.1s;
}
.patient-list-item:hover { background-color: #334155; }
.patient-list-item.selected { background-color: #2563eb; border-left: 4px solid #60a5fa; }
.pt-name { font-weight: bold; font-size: 15px; color: #f1f5f9; }
.pt-id { font-size: 12px; color: #94a3b8; }

/* Detail View */
.detail-table { width: 100%; }
.detail-table td { border-bottom: 1px solid #334155; padding: 10px 0; }
.detail-label { display: block; font-size: 11px; color: #94a3b8; margin-bottom: 2px; }
.detail-value { font-size: 14px; color: #f1f5f9; font-weight: 500; }

/* Main Panel Elements */
.main-header {
    height: 64px;
    background: #fff;
    border-bottom: 1px solid #e2e8f0;
    padding: 0 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.app-title { font-size: 18px; color: #0f172a; font-weight: bold; display: flex; align-items: center; gap: 10px; }
.loader { display:none; font-size:12px; color:#2563eb; margin-left:10px; font-weight:normal; }
.current-patient-name { font-size: 18px; color: #2563eb; font-weight: bold; }

.cards-area {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}

.card {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    overflow: hidden;
}
.card-header {
    padding: 12px 20px;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    font-weight: bold;
    color: #1e293b;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.card-title { display: flex; align-items: center; gap: 8px; }
.card-header.blue { border-left: 4px solid #3b82f6; background: linear-gradient(to right, #eff6ff, #fff); }
.card-header.green { border-left: 4px solid #22c55e; background: linear-gradient(to right, #f0fdf4, #fff); }
.card-header.yellow { border-left: 4px solid #eab308; background: linear-gradient(to right, #fefce8, #fff); }

.card-body { padding: 0; overflow-x: auto; }
.empty-msg { padding: 30px; text-align: center; color: #94a3b8; }
.empty-msg.error { color: #fef2f2; background: #b91c1c; border: 1px solid #991b1b; padding: 15px; border-radius: 4px; text-align: left; font-size: 12px; white-space: pre-wrap; word-break: break-all; }

/* Tables */
table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 600px; }
th { background: #f8fafc; color: #64748b; padding: 10px 15px; text-align: left; font-weight: 600; border-bottom: 1px solid #e2e8f0; white-space: nowrap; }
td { padding: 10px 15px; border-bottom: 1px solid #f1f5f9; color: #334155; white-space: nowrap; }
tr:hover { background: #f8fafc; }
.status-active { color: #16a34a; font-weight: bold; background: #dcfce7; padding: 2px 8px; border-radius: 10px; font-size: 11px; }
.status-old { color: #64748b; background: #f1f5f9; padding: 2px 8px; border-radius: 10px; font-size: 11px; }

/* Forms & Modals */
.btn { padding: 6px 14px; border-radius: 5px; cursor: pointer; border: none; font-size: 13px; font-weight: 500; transition: background 0.1s; }
.btn-primary { background: #2563eb; color: #fff; }
.btn-primary:hover { background: #1d4ed8; }
.btn-secondary { background: #fff; color: #475569; border: 1px solid #cbd5e1; }
.btn-secondary:hover { background: #f1f5f9; border-color: #94a3b8; }
.btn-block { width: 100%; display: block; margin-bottom: 10px; padding: 10px; }

.modal-overlay {
    display: none;
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(15,23,42,0.7);
    z-index: 100;
    align-items: center; justify-content: center;
}
.modal-box {
    background: #fff; width: 500px; max-width: 90%;
    padding: 25px; border-radius: 12px;
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
}
.modal-title { font-size: 18px; font-weight: bold; margin-bottom: 20px; color: #0f172a; }
.form-group { margin-bottom: 15px; }
.form-label { display: block; font-size: 13px; font-weight: bold; color: #475569; margin-bottom: 5px; }
.form-input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; }
</style>

<script language="JavaScript">
// Global Data
var gDbPath = "";
var gLockPath = "";
var gCurrentPID = "";
var gPatients = [];
var gDevices = [];
var gSettings = [];
var gMeasurements = [];

var MAX_RETRIES = 5;
var RETRY_DELAY_MS = 1000;

// Initialize
window.onload = function() {
    try {
        setTimeout(function() {
            window.moveTo(0, 0);
            window.resizeTo(screen.availWidth, screen.availHeight);
        }, 100);

        var fso = new ActiveXObject("Scripting.FileSystemObject");
        var path = document.location.pathname;
        path = path.replace(/\//g, "\\");
        if (path.substring(0, 1) == "\\") path = path.substring(1); 
        gDbPath = fso.GetParentFolderName(path) + "\\CIED_DB.xlsx";
        gLockPath = fso.GetParentFolderName(path) + "\\CIED_DB.lock";
        
        if (!fso.FileExists(gDbPath)) {
            document.getElementById("patient-list-container").innerHTML = "<div class='empty-msg error'>ファイルが見つかりません:<br>" + gDbPath + "</div>";
            return;
        }

        loadAllData();
        
    } catch(e) {
        document.getElementById("patient-list-container").innerHTML = "<div class='empty-msg error'>起動エラー:<br>" + e.message + "</div>";
    }
};

function setStatus(msg) {
    document.getElementById("status-msg").innerText = msg;
    var ind = document.getElementById("loading-indicator");
    if(msg.indexOf("...") > -1) {
        ind.style.display = "inline";
        ind.innerText = msg;
    } else {
        ind.style.display = "none";
    }
}

// --- Excel Automation (Read) ---
function loadAllData() {
    setStatus("データ同期中...");
    
    var excel = null;
    var book = null;
    try {
        excel = new ActiveXObject("Excel.Application");
        excel.Visible = false;
        excel.DisplayAlerts = false;
        
        // ReadOnly=True で開く（共有ロックを回避）
        book = excel.Workbooks.Open(gDbPath, 0, true); 
        
        gPatients = readSheetData(book.Sheets("T_Patients"));
        gDevices = readSheetData(book.Sheets("T_DeviceConfig"));
        gSettings = readSheetData(book.Sheets("T_Settings"));
        gMeasurements = readSheetData(book.Sheets("T_Measurements"));
        
        book.Close(false);
        excel.Quit();
        excel = null;
        
        renderPatientList();
        
    } catch(e) {
        if(book) { try{book.Close(false);}catch(e2){} }
        if(excel) { try{excel.Quit();}catch(e2){} }
        document.getElementById("patient-list-container").innerHTML = "<div class='empty-msg error'>読み込みエラー:<br>" + e.message + "</div>";
        setStatus("");
    }
}

function readSheetData(sheet) {
    var data = [];
    try {
        var usedRange = sheet.UsedRange;
        var rowCount = usedRange.Rows.Count;
        var colCount = usedRange.Columns.Count;
        
        if (rowCount <= 1) return [];
        
        // VBArrayをJScript配列に変換（これは Column-Major = 列優先 になる）
        // Index = (ColIndex - 1) * RowCount + (RowIndex - 1)
        var vArray = new VBArray(usedRange.Value).toArray();
        
        // ヘッダー行 (Row 1) の取得
        var headers = [];
        for(var c=1; c<=colCount; c++) {
            var idx = (c - 1) * rowCount;
            headers.push(vArray[idx]); 
        }
        
        // データ行 (Row 2 .. RowCount) の取得
        for(var r=2; r<=rowCount; r++) {
            var rowObj = {};
            var hasData = false;
            for(var c=1; c<=colCount; c++) {
                var idx = (c - 1) * rowCount + (r - 1);
                var val = vArray[idx];
                var key = headers[c-1];
                
                if (val !== undefined && val !== null) {
                    rowObj[key] = formatDate(val);
                    if (val !== "") hasData = true;
                } else {
                    rowObj[key] = "";
                }
            }
            if(hasData) data.push(rowObj);
        }
        
    } catch(e) { /* Ignore sheet errors */ }
    return data;
}

function formatDate(val) {
    try {
        // Excel日付シリアルの判定と変換は複雑なので、Dateオブジェクトなら変換
        var d = new Date(val);
        if(!isNaN(d) && d.getFullYear() > 1900) {
             var y = d.getFullYear();
             var m = d.getMonth() + 1;
             var dd = d.getDate();
             return y + "/" + (m<10?"0"+m:m) + "/" + (dd<10?"0"+dd:dd);
        }
    } catch(e){}
    return val + "";
}

// --- Logic ---

function showTab(mode) {
    document.getElementById('btn-list').className = 'sidebar-tab' + (mode=='list'?' active':'');
    document.getElementById('btn-info').className = 'sidebar-tab' + (mode=='info'?' active':'');
    document.getElementById('tab-list').className = 'sidebar-content' + (mode=='list'?' active':'');
    document.getElementById('tab-info').className = 'sidebar-content' + (mode=='info'?' active':'');
    
    // Refresh list if returning
    if(mode == 'list') filterList();
}

function renderPatientList() {
    var container = document.getElementById("patient-list-container");
    var html = "";
    var count = 0;
    
    for(var i=0; i<gPatients.length; i++) {
        var p = gPatients[i];
        if(!p["氏名"]) continue;
        
        html += "<div class='patient-list-item' pid='" + p["PatientID"] + "' onclick='selectPatient(\"" + p["PatientID"] + "\")'>";
        html += "<div class='pt-name'>" + p["氏名"] + "</div>";
        html += "<div class='pt-id'>" + p["カルテ番号"] + "</div>";
        html += "</div>";
        count++;
    }
    
    if (count === 0) html = "<div class='empty-msg'>データなし</div>";
    
    container.innerHTML = html;
    setStatus(count + " 件");
    filterList();
}

function selectPatient(pid) {
    gCurrentPID = pid;
    
    var items = document.getElementsByClassName("patient-list-item");
    for(var i=0; i<items.length; i++) {
        items[i].className = "patient-list-item";
        if(items[i].getAttribute("pid") == pid) items[i].className += " selected";
    }
    
    var p = null;
    for(var i=0; i<gPatients.length; i++) {
        if(gPatients[i]["PatientID"] == pid) { p = gPatients[i]; break; }
    }
    
    if (p) {
        var html = "<div style='text-align:center; padding:20px 0;'>";
        html += "<div style='font-size:48px; margin-bottom:10px;'></div>";
        html += "<div style='font-size:18px; font-weight:bold; color:#fff;'>" + p["氏名"] + "</div>";
        html += "</div>";
        
        html += "<table class='detail-table'>";
        html += "<tr><td><span class='detail-label'>カルテ番号</span><span class='detail-value'>" + p["カルテ番号"] + "</span></td></tr>";
        html += "<tr><td><span class='detail-label'>生年月日</span><span class='detail-value'>" + p["生年月日"] + "</span></td></tr>";
        html += "<tr><td><span class='detail-label'>性別</span><span class='detail-value'>" + p["性別"] + "</span></td></tr>";
        html += "<tr><td><span class='detail-label'>電話番号</span><span class='detail-value'>" + p["電話番号"] + "</span></td></tr>";
        html += "<tr><td><span class='detail-label'>原疾患</span><span class='detail-value'>" + p["原疾患"] + "</span></td></tr>";
        html += "<tr><td><span class='detail-label'>住所</span><span class='detail-value'>" + p["住所"] + "</span></td></tr>";
        html += "</table>";
        
        document.getElementById("patient-detail-container").innerHTML = html;
        document.getElementById("current-patient-name").innerText = p["氏名"] + " 様";
        
        renderSubData(gDevices, "PatientID", pid, "device-body", ["手術日", "本体メーカー", "本体型番", "本体Serial", "ステータス"]);
        renderSubData(gSettings, "PatientID", pid, "settings-body", ["設定日", "Mode", "LowerRate", "UpperRate", "AV_Delay"]);
        renderSubData(gMeasurements, "PatientID", pid, "measurement-body", ["計測日", "Sensing_A", "Sensing_V", "Impedance_A", "Impedance_RV"]);
        
        showTab('info');
    }
}

function renderSubData(sourceArray, keyField, keyVal, targetId, headers) {
    var html = "<div class='empty-msg'>履歴なし</div>";
    var rows = [];
    
    for(var i=0; i<sourceArray.length; i++) {
        if(sourceArray[i][keyField] == keyVal) {
            rows.push(sourceArray[i]);
        }
    }
    rows.sort(function(a,b){ return (a[headers[0]] < b[headers[0]]) ? 1 : -1; });
    
    if(rows.length > 0) {
        html = "<table><tr>";
        for(var h=0; h<headers.length; h++) html += "<th>"+headers[h]+"</th>";
        html += "</tr>";
        
        for(var i=0; i<rows.length; i++) {
            html += "<tr>";
            for(var h=0; h<headers.length; h++) {
                var val = rows[i][headers[h]];
                if(headers[h]=="ステータス") {
                    if(val=="Active") val = "<span class='status-active'>Active</span>";
                    else val = "<span class='status-old'>Old</span>";
                }
                html += "<td>" + val + "</td>";
            }
            html += "</tr>";
        }
        html += "</table>";
    }
    document.getElementById(targetId).innerHTML = html;
}

function filterList() {
    var key = document.getElementById('search-box').value.toLowerCase();
    var items = document.getElementsByClassName("patient-list-item");
    for(var i=0; i<items.length; i++) {
        var text = items[i].innerText.toLowerCase();
        items[i].style.display = (text.indexOf(key) > -1) ? 'block' : 'none';
    }
}

// --- Lock & Save (Concurrency Control) ---
function generateID(prefix) {
    var d = new Date();
    return prefix + d.getFullYear() + (d.getMonth()+1) + d.getDate() + d.getHours() + d.getMinutes() + d.getSeconds();
}

function acquireLock() {
    var fso = new ActiveXObject("Scripting.FileSystemObject");
    // Check if lock exists
    if (fso.FileExists(gLockPath)) return false;
    try {
        var f = fso.CreateTextFile(gLockPath, false); // Fail if exists
        f.WriteLine(new Date());
        f.Close();
        return true;
    } catch(e) {
        return false;
    }
}

function releaseLock() {
    var fso = new ActiveXObject("Scripting.FileSystemObject");
    if(fso.FileExists(gLockPath)) {
        try { fso.DeleteFile(gLockPath, true); } catch(e){}
    }
}

function savePatient() {
    setStatus("保存準備中...");
    
    // Lock Retry Loop with setTimeout is hard in synchronous flow.
    // We try once, if locked, user must retry. Or simple loop.
    
    if (!acquireLock()) {
        alert("他のユーザーが編集中です。数秒待ってから再度「登録」を押してください。");
        setStatus("");
        return;
    }
    
    var excel = null;
    var book = null;
    
    try {
        setStatus("Excelへ書き込み中...");
        
        var k = document.getElementById('np_karte').value;
        var n = document.getElementById('np_name').value;
        var b = document.getElementById('np_birth').value;
        var s = document.getElementById('np_sex').value;
        var d = document.getElementById('np_dis').value;
        var a = document.getElementById('np_addr').value;
        var p = document.getElementById('np_tel').value;
        var id = generateID("P");
        
        excel = new ActiveXObject("Excel.Application");
        excel.Visible = false;
        excel.DisplayAlerts = false;
        
        // Open Read/Write
        book = excel.Workbooks.Open(gDbPath);
        var sheet = book.Sheets("T_Patients");
        var lastRow = sheet.UsedRange.Rows.Count + 1;
        
        sheet.Cells(lastRow, 1).Value = id;
        sheet.Cells(lastRow, 2).Value = k;
        sheet.Cells(lastRow, 3).Value = n;
        sheet.Cells(lastRow, 4).Value = b;
        sheet.Cells(lastRow, 5).Value = s;
        sheet.Cells(lastRow, 6).Value = d;
        sheet.Cells(lastRow, 7).Value = a;
        sheet.Cells(lastRow, 8).Value = p;
        
        book.Save();
        book.Close();
        excel.Quit();
        excel = null;
        
        closeModal();
        releaseLock();
        
        alert("登録完了しました。");
        loadAllData(); // Reload
        
    } catch(e) {
        if(book) { try{book.Close(false);}catch(e2){} }
        if(excel) { try{excel.Quit();}catch(e2){} }
        releaseLock(); // Make sure to release
        alert("保存エラー: " + e.message);
        setStatus("");
    }
}

function showNewPatientModal() {
    var modal = document.getElementById("modal-overlay");
    var content = document.getElementById("modal-content");
    var html = "<div class='modal-title'>新規患者登録</div>";
    
    html += "<div class='form-group'><label class='form-label'>カルテ番号</label><input class='form-input' id='np_karte'></div>";
    html += "<div class='form-group'><label class='form-label'>氏名</label><input class='form-input' id='np_name'></div>";
    html += "<div class='form-group'><label class='form-label'>生年月日</label><input class='form-input' type='date' id='np_birth'></div>";
    html += "<div class='form-group'><label class='form-label'>性別</label><select class='form-input' id='np_sex'><option>男</option><option>女</option></select></div>";
    html += "<div class='form-group'><label class='form-label'>原疾患</label><input class='form-input' id='np_dis'></div>";
    html += "<div class='form-group'><label class='form-label'>住所</label><input class='form-input' id='np_addr'></div>";
    html += "<div class='form-group'><label class='form-label'>電話番号</label><input class='form-input' id='np_tel'></div>";
    
    html += "<div style='text-align:right; margin-top:20px;'>";
    html += "<button class='btn btn-secondary' onclick='closeModal()'>キャンセル</button> ";
    html += "<button class='btn btn-primary' onclick='savePatient()'>登録保存</button>";
    html += "</div>";
    
    content.innerHTML = html;
    modal.style.display = "flex";
}
function closeModal() { document.getElementById("modal-overlay").style.display = "none"; }
function showDeviceModal() { alert("未実装"); }
function showSettingsModal() { alert("未実装"); }
function showMeasurementModal() { alert("未実装"); }

</script>
</head>
<body>

<div id="sidebar-panel">
    <div class="sidebar-header">
        <button id="btn-list" class="sidebar-tab active" onclick="showTab('list')">リスト</button>
        <button id="btn-info" class="sidebar-tab" onclick="showTab('info')">基本情報</button>
    </div>
    
    <div id="tab-list" class="sidebar-content active">
        <input type="text" class="search-box" id="search-box" onkeyup="filterList()" placeholder="検索: カルテNo / 氏名">
        <div id="status-msg" style="color:#fcd34d; font-size:12px; margin-bottom:5px;">Loading...</div>
        <div id="patient-list-container"></div>
        
        <div style="margin-top:20px; padding-top:20px; border-top:1px solid #334155;">
            <button class="btn btn-primary btn-block" onclick="showNewPatientModal()">＋ 新規患者登録</button>
            <button class="btn btn-secondary btn-block" style="background:#334155; color:#ccc; border:1px solid #475569;" onclick="alert('CSV取込')"> CSV取込</button>
        </div>
    </div>
    
    <div id="tab-info" class="sidebar-content">
        <div id="patient-detail-container">
            <div style="text-align:center; padding-top:60px; color:#94a3b8;">
                <p>リストから<br>患者を選択してください</p>
                <br>
                <button class="btn btn-secondary" style="background:#334155; color:#fff;" onclick="showTab('list')">リストに戻る</button>
            </div>
        </div>
    </div>
</div>

<div id="main-panel">
    <div class="main-header">
        <div class="app-title"> CIEDs 患者管理システム <span id="loading-indicator" class="loader">通信中...</span></div>
        <div id="current-patient-name" class="current-patient-name"></div>
    </div>
    
    <div class="cards-area">
        <!-- Device -->
        <div class="card">
            <div class="card-header blue">
                <div class="card-title"> デバイス情報</div>
                <button class="btn btn-secondary" onclick="showDeviceModal()">追加</button>
            </div>
            <div class="card-body" id="device-body">
                <div class="empty-msg">データなし</div>
            </div>
        </div>
        
        <!-- Settings -->
        <div class="card">
            <div class="card-header green">
                <div class="card-title"> 設定情報</div>
                <button class="btn btn-secondary" onclick="showSettingsModal()">追加</button>
            </div>
            <div class="card-body" id="settings-body">
                <div class="empty-msg">データなし</div>
            </div>
        </div>
        
        <!-- Measurements -->
        <div class="card">
            <div class="card-header yellow">
                <div class="card-title"> 測定情報</div>
                <button class="btn btn-secondary" onclick="showMeasurementModal()">追加</button>
            </div>
            <div class="card-body" id="measurement-body">
                <div class="empty-msg">データなし</div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="modal-overlay" class="modal-overlay">
    <div id="modal-content" class="modal-box"></div>
</div>

</body>
</html>
