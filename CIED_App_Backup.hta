<html>
<head>
<title>CIEDs Patient Management System</title>
<HTA:APPLICATION
    ID="CIEDApp"
    APPLICATIONNAME="CIEDsSystem"
    BORDER="thick"
    BORDERSTYLE="normal"
    CAPTION="yes"
    ICON=""
    MAXIMIZEBUTTON="yes"
    MINIMIZEBUTTON="yes"
    SHOWINTASKBAR="yes"
    SINGLEINSTANCE="yes"
    SYSMENU="yes"
    VERSION="3.2"
    WINDOWSTATE="maximize"
    NAVIGABLE="yes"
/>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta charset="Shift_JIS">
<style>
/* Reset & Base */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: 'Meiryo', 'Segoe UI', sans-serif; 
    background-color: #f8fafc; 
    color: #333; 
    height: 100vh; 
    width: 100vw;
    overflow: hidden; 
}
button, input, select, textarea { font-family: inherit; }

/* Layout */
#sidebar-panel {
    position: absolute;
    top: 0; left: 0; bottom: 0;
    width: 320px;
    background-color: #1e293b;
    border-right: 1px solid #475569;
    z-index: 10;
    display: flex;
    flex-direction: column;
}
#main-panel {
    position: absolute;
    top: 0; left: 320px; right: 0; bottom: 0;
    background-color: #f8fafc;
    display: flex;
    flex-direction: column;
}

/* Sidebar Elements */
.sidebar-header {
    height: 50px;
    background-color: #0f172a;
    display: flex;
}
.sidebar-tab {
    flex: 1;
    background: transparent;
    color: #94a3b8;
    border: none;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
}
.sidebar-tab:hover { background: rgba(255,255,255,0.05); }
.sidebar-tab.active {
    color: #fff;
    background: #1e293b;
    border-bottom: 3px solid #3b82f6;
}

.sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    display: none;
}
.sidebar-content.active { display: block; }

.search-box {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    background: #334155;
    border: 1px solid #475569;
    color: #fff;
    border-radius: 4px;
}

.patient-list-item {
    padding: 12px;
    border-bottom: 1px solid #334155;
    cursor: pointer;
    transition: background 0.1s;
}
.patient-list-item:hover { background-color: #334155; }
.patient-list-item.selected { background-color: #2563eb; border-left: 4px solid #60a5fa; }
.pt-name { font-weight: bold; font-size: 15px; color: #f1f5f9; }
.pt-id { font-size: 12px; color: #94a3b8; }

/* Detail View */
.detail-table { width: 100%; }
.detail-table td { border-bottom: 1px solid #334155; padding: 10px 0; }
.detail-table tr:hover { background: transparent; }
.detail-label { display: block; font-size: 11px; color: #94a3b8; margin-bottom: 2px; }
.detail-value { font-size: 14px; color: #f1f5f9; font-weight: 500; }

/* Main Panel Elements */
.main-header {
    height: 64px;
    background: #fff;
    border-bottom: 1px solid #e2e8f0;
    padding: 0 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.app-title { font-size: 18px; color: #0f172a; font-weight: bold; display: flex; align-items: center; gap: 10px; }
.loader { display:none; font-size:12px; color:#2563eb; margin-left:10px; font-weight:normal; }
.current-patient-name { font-size: 18px; color: #2563eb; font-weight: bold; }

.cards-area {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}

.card {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    overflow: hidden;
}
.card-header {
    padding: 12px 20px;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    font-weight: bold;
    color: #1e293b;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.card-title { display: flex; align-items: center; gap: 8px; }
.card-header.blue { border-left: 4px solid #3b82f6; background: linear-gradient(to right, #eff6ff, #fff); }
.card-header.green { border-left: 4px solid #22c55e; background: linear-gradient(to right, #f0fdf4, #fff); }
.card-header.yellow { border-left: 4px solid #eab308; background: linear-gradient(to right, #fefce8, #fff); }

.card-body { padding: 0; overflow-x: auto; }
.empty-msg { padding: 30px; text-align: center; color: #94a3b8; }
.empty-msg.error { color: #fef2f2; background: #b91c1c; border: 1px solid #991b1b; padding: 15px; border-radius: 4px; text-align: left; font-size: 12px; white-space: pre-wrap; word-break: break-all; }

/* Tables */
table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 600px; }
th { background: #f8fafc; color: #64748b; padding: 10px 15px; text-align: left; font-weight: 600; border-bottom: 1px solid #e2e8f0; white-space: nowrap; }
td { padding: 10px 15px; border-bottom: 1px solid #f1f5f9; color: #334155; white-space: nowrap; }
.card-body tr:hover { background: #f8fafc; }
.status-active { color: #16a34a; font-weight: bold; background: #dcfce7; padding: 2px 8px; border-radius: 10px; font-size: 11px; }
.status-old { color: #64748b; background: #f1f5f9; padding: 2px 8px; border-radius: 10px; font-size: 11px; }

/* Forms & Modals */
.btn { padding: 6px 14px; border-radius: 5px; cursor: pointer; border: none; font-size: 13px; font-weight: 500; transition: background 0.1s; }
.btn-primary { background: #2563eb; color: #fff; }
.btn-primary:hover { background: #1d4ed8; }
.btn-secondary { background: #fff; color: #475569; border: 1px solid #cbd5e1; }
.btn-secondary:hover { background: #f1f5f9; border-color: #94a3b8; }
.btn-block { width: 100%; display: block; margin-bottom: 10px; padding: 10px; }

.modal-overlay {
    display: none;
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(15,23,42,0.7);
    z-index: 100;
    align-items: center; justify-content: center;
}
.modal-box {
    background: #fff; width: 500px; max-width: 90%;
    padding: 25px; border-radius: 12px;
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
}
.modal-box.wide { width: 800px; }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.form-section-title { grid-column: 1 / span 2; font-weight: bold; padding: 10px 0; border-bottom: 2px solid #e2e8f0; margin-top: 10px; color: #1e293b; }
.modal-title { font-size: 18px; font-weight: bold; margin-bottom: 20px; color: #0f172a; }
.form-group { margin-bottom: 15px; }
.form-label { display: block; font-size: 13px; font-weight: bold; color: #475569; margin-bottom: 5px; }
.form-input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; }
</style>

<script language="JavaScript">
// Global Data
var gDbPath = "";
var gLockPath = "";
var gCurrentPID = "";
var gPatients = [];
var gDevices = [];
var gSettings = [];
var gMeasurements = [];

var MAX_RETRIES = 5;
var RETRY_DELAY_MS = 1000;

// Initialize
window.onload = function() {
    try {
        setTimeout(function() {
            window.moveTo(0, 0);
            window.resizeTo(screen.availWidth, screen.availHeight);
        }, 100);

        var fso = new ActiveXObject("Scripting.FileSystemObject");
        var path = document.location.pathname;
        path = path.replace(/\//g, "\\");
        if (path.substring(0, 1) == "\\") path = path.substring(1); 
        gDbPath = fso.GetParentFolderName(path) + "\\CIED_DB.xlsx";
        gLockPath = fso.GetParentFolderName(path) + "\\CIED_DB.lock";
        
        if (!fso.FileExists(gDbPath)) {
            document.getElementById("patient-list-container").innerHTML = "<div class='empty-msg error'>ファイルが見つかりません:<br>" + gDbPath + "</div>";
            return;
        }

        loadAllData();
        
    } catch(e) {
        document.getElementById("patient-list-container").innerHTML = "<div class='empty-msg error'>起動エラー:<br>" + e.message + "</div>";
    }
};

function setStatus(msg) {
    document.getElementById("status-msg").innerText = msg;
    var ind = document.getElementById("loading-indicator");
    if(msg.indexOf("...") > -1) {
        ind.style.display = "inline";
    } else {
        ind.style.display = "none";
    }
}

// --- Excel Automation (Read) ---
function loadAllData() {
    setStatus("データ同期中...");
    
    var excel = null;
    var book = null;
    try {
        excel = new ActiveXObject("Excel.Application");
        excel.Visible = false;
        excel.DisplayAlerts = false;
        
        book = excel.Workbooks.Open(gDbPath, 0, true); 
        
        gPatients = readSheetData(book.Sheets("T_Patients"));
        gDevices = readSheetData(book.Sheets("T_DeviceConfig"));
        gSettings = readSheetData(book.Sheets("T_Settings"));
        gMeasurements = readSheetData(book.Sheets("T_Measurements"));
        
        book.Close(false);
        excel.Quit();
        excel = null;
        
        renderPatientList();
        
    } catch(e) {
        if(book) { try{book.Close(false);}catch(e2){} }
        if(excel) { try{excel.Quit();}catch(e2){} }
        document.getElementById("patient-list-container").innerHTML = "<div class='empty-msg error'>読み込みエラー:<br>" + e.message + "</div>";
        setStatus("");
    }
}

function readSheetData(sheet) {
    var data = [];
    try {
        var usedRange = sheet.UsedRange;
        var rowCount = usedRange.Rows.Count;
        var colCount = usedRange.Columns.Count;
        
        if (rowCount <= 1) return [];
        
        var vArray = new VBArray(usedRange.Value).toArray();
        var headers = [];
        for(var c=1; c<=colCount; c++) {
            var idx = (c - 1) * rowCount;
            headers.push(vArray[idx]); 
        }
        
        for(var r=2; r<=rowCount; r++) {
            var rowObj = {};
            var hasData = false;
            for(var c=1; c<=colCount; c++) {
                var idx = (c - 1) * rowCount + (r - 1);
                var val = vArray[idx];
                var key = headers[c-1];
                
                if (val !== undefined && val !== null) {
                    rowObj[key] = formatDate(key, val);
                    if (val !== "") hasData = true;
                } else {
                    rowObj[key] = "";
                }
            }
            if(hasData) data.push(rowObj);
        }
    } catch(e) { }
    return data;
}

function formatDate(key, val) {
    // Only format if the column name implies a date, or if its a Date object
    var dateKeys = ["BirthDate", "RegistrationDate", "ImplantDate", "SettingDate", "MeasureDate"];
    var isDateKey = false;
    for(var i=0; i<dateKeys.length; i++) { if(key == dateKeys[i]) isDateKey = true; }
    
    if(!isDateKey) return val + "";

    try {
        var d = new Date(val);
        if(!isNaN(d) && d.getFullYear() > 1900) {
             var y = d.getFullYear();
             var m = d.getMonth() + 1;
             var dd = d.getDate();
             return y + "/" + (m<10?"0"+m:m) + "/" + (dd<10?"0"+dd:dd);
        }
    } catch(e){}
    return val + "";
}

// --- Logic ---
function showTab(mode) {
    document.getElementById('btn-list').className = 'sidebar-tab' + (mode=='list'?' active':'');
    document.getElementById('btn-info').className = 'sidebar-tab' + (mode=='info'?' active':'');
    document.getElementById('tab-list').className = 'sidebar-content' + (mode=='list'?' active':'');
    document.getElementById('tab-info').className = 'sidebar-content' + (mode=='info'?' active':'');
    if(mode == 'list') filterList();
}

function renderPatientList() {
    var container = document.getElementById("patient-list-container");
    var html = "";
    var count = 0;
    for(var i=0; i<gPatients.length; i++) {
        var p = gPatients[i];
        if(!p["Name"]) continue;
        html += "<div class='patient-list-item' pid='" + p["PatientID"] + "' onclick='selectPatient(\"" + p["PatientID"] + "\")'>";
        html += "<div class='pt-name'>" + p["Name"] + " (" + (p["NameKana"] || "") + ")</div>";
        html += "<div class='pt-id'>" + p["PatientID"] + "</div>";
        html += "</div>";
        count++;
    }
    if (count === 0) html = "<div class='empty-msg'>データなし</div>";
    container.innerHTML = html;
    setStatus(count + " 件");
}

function calculateAge(birthDateStr) {
    if (!birthDateStr) return "-";
    try {
        var birthDate = new Date(birthDateStr);
        if (isNaN(birthDate)) return "-";
        var today = new Date();
        var age = today.getFullYear() - birthDate.getFullYear();
        var m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
        return age + "歳";
    } catch(e) { return "-"; }
}

function selectPatient(pid) {
    gCurrentPID = pid;
    var items = document.getElementsByClassName("patient-list-item");
    for(var i=0; i<items.length; i++) {
        items[i].className = "patient-list-item";
        if(items[i].getAttribute("pid") == pid) items[i].className += " selected";
    }
    
    var p = null;
    for(var i=0; i<gPatients.length; i++) {
        if(gPatients[i]["PatientID"] == pid) { p = gPatients[i]; break; }
    }
    
    if (p) {
        var html = "<div style='text-align:center; padding:20px 0;'>";
        html += "<div style='font-size:18px; font-weight:bold; color:#fff;'>" + (p["Name"] || "No Name") + "</div>";
        html += "</div>";
        html += "<table class='detail-table'>";
        html += "<tr><td><span class='detail-label'>患者ID / カルテ番号</span><span class='detail-value'>" + (p["PatientID"] || "-") + "</span></td></tr>";
        html += "<tr><td><span class='detail-label'>氏名 (カナ)</span><span class='detail-value'>" + (p["Name"] || "-") + " (" + (p["NameKana"] || "-") + ")</span></td></tr>";
        html += "<tr><td><span class='detail-label'>性別 / 生年月日</span><span class='detail-value'>" + (p["Sex"] || "-") + " / " + (p["BirthDate"] || "-") + " (" + calculateAge(p["BirthDate"]) + ")</span></td></tr>";
        html += "<tr><td><span class='detail-label'>住所</span><span class='detail-value'>〒" + (p["PostalCode"] || "-") + "<br>" + (p["Address"] || "-") + "</span></td></tr>";
        html += "<tr><td><span class='detail-label'>電話番号</span><span class='detail-value'>" + (p["Phone"] || "-") + "</span></td></tr>";
        html += "<tr><td><span class='detail-label'>MRI対応</span><span class='detail-value'>" + (p["MRICompatible"] || "-") + "</span></td></tr>";
        html += "<tr><td><span class='detail-label'>RMS導入 / 送信機</span><span class='detail-value'>" + (p["RMS_Enabled"] || "No") + " / " + (p["RMS_TransmitterType"] || "-") + "</span></td></tr>";
        html += "<tr><td><span class='detail-label'>登録日</span><span class='detail-value'>" + (p["RegistrationDate"] || "-") + "</span></td></tr>";
        html += "</table>";
        
        document.getElementById("patient-detail-container").innerHTML = html;
        document.getElementById("current-patient-name").innerText = (p["Name"] || "") + " 様";
        
        renderSubData(gDevices, "PatientID", pid, "device-body", 
            ["ImplantDate", "Manufacturer", "ModelNumber", "SerialNumber", "Status"],
            ["植込み日", "メーカー", "型番", "Serial", "状態"],
            "ConfigID");
        renderSubData(gSettings, "PatientID", pid, "settings-body", 
            ["SettingDate", "Mode", "LowerRate", "UpperRate", "AV_Delay"],
            ["設定日", "Mode", "LRL", "URL", "AVD"]);
        renderSubData(gMeasurements, "PatientID", pid, "measurement-body", 
            ["MeasureDate", "Sensing_A", "Sensing_V", "Impedance_A", "Impedance_RV"],
            ["測定日", "Sense A", "Sense V", "Imp A", "Imp RV"]);
        showTab('info');
    }
}

function renderSubData(sourceArray, keyField, keyVal, targetId, keys, labels, idField) {
    if(!labels) labels = keys;
    var html = "<div class='empty-msg'>履歴なし</div>";
    var rows = [];
    for(var i=0; i<sourceArray.length; i++) {
        if(sourceArray[i][keyField] == keyVal) rows.push(sourceArray[i]);
    }
    rows.sort(function(a,b){ return (a[keys[0]] < b[keys[0]]) ? 1 : -1; });
    
    if(rows.length > 0) {
        html = "<table><tr>";
        for(var h=0; h<labels.length; h++) html += "<th>"+labels[h]+"</th>";
        html += "</tr>";
        for(var i=0; i<rows.length; i++) {
            var rowAttr = idField ? " onclick='onRowClick(\"" + targetId + "\", \"" + rows[i][idField] + "\")' style='cursor:pointer'" : "";
            html += "<tr" + rowAttr + ">";
            for(var h=0; h<keys.length; h++) {
                var val = rows[i][keys[h]];
                var k = keys[h];
                if(k=="Status" || k=="ステータス") {
                    if(val=="Active") val = "<span class='status-active'>Active</span>";
                    else val = "<span class='status-old'>Old</span>";
                }
                html += "<td>" + (val || "") + "</td>";
            }
            html += "</tr>";
        }
        html += "</table>";
    }
    document.getElementById(targetId).innerHTML = html;
}

function onRowClick(targetId, id) {
    if(targetId == "device-body") showDeviceDetailModal(id);
}

function filterList() {
    var key = document.getElementById('search-box').value.toLowerCase();
    var items = document.getElementsByClassName("patient-list-item");
    for(var i=0; i<items.length; i++) {
        var text = items[i].innerText.toLowerCase();
        items[i].style.display = (text.indexOf(key) > -1) ? 'block' : 'none';
    }
}

function acquireLock() {
    var fso = new ActiveXObject("Scripting.FileSystemObject");
    if (fso.FileExists(gLockPath)) return false;
    try {
        var f = fso.CreateTextFile(gLockPath, false);
        f.WriteLine(new Date());
        f.Close();
        return true;
    } catch(e) { return false; }
}

function releaseLock() {
    var fso = new ActiveXObject("Scripting.FileSystemObject");
    if(fso.FileExists(gLockPath)) { try { fso.DeleteFile(gLockPath, true); } catch(e){} }
}

function savePatient() {
    if (!acquireLock()) { alert("他のユーザーが編集中です。"); return; }
    var excel = null; var book = null;
    try {
        var pid = document.getElementById('np_pid').value;
        var name = document.getElementById('np_name').value;
        var kana = document.getElementById('np_kana').value;
        var birth = document.getElementById('np_birth').value;
        var sex = document.getElementById('np_sex').value;
        var zip = document.getElementById('np_zip').value;
        var addr = document.getElementById('np_addr').value;
        var tel = document.getElementById('np_tel').value;
        var mri = document.getElementById('np_mri').value;
        var rms_en = document.getElementById('np_rms_en').value;
        var rms_type = document.getElementById('np_rms_type').value;

        excel = new ActiveXObject("Excel.Application");
        book = excel.Workbooks.Open(gDbPath);
        var sheet = book.Sheets("T_Patients");
        var lastRow = sheet.UsedRange.Rows.Count + 1;
        sheet.Cells(lastRow, 1).Value = pid;
        sheet.Cells(lastRow, 2).Value = name;
        sheet.Cells(lastRow, 3).Value = kana;
        sheet.Cells(lastRow, 4).Value = sex;
        sheet.Cells(lastRow, 5).Value = birth;
        sheet.Cells(lastRow, 6).Value = zip;
        sheet.Cells(lastRow, 7).Value = addr;
        sheet.Cells(lastRow, 8).Value = "'" + tel;
        sheet.Cells(lastRow, 9).Value = mri;
        sheet.Cells(lastRow, 10).Value = rms_en;
        sheet.Cells(lastRow, 11).Value = rms_type;
        sheet.Cells(lastRow, 12).Value = new Date().toLocaleDateString();
        
        book.Save();
        book.Close();
        excel.Quit();
        closeModal();
        releaseLock();
        alert("登録完了");
        loadAllData();
    } catch(e) {
        if(book) book.Close(false); if(excel) excel.Quit();
        releaseLock(); alert("エラー: " + e.message);
    }
}

function showNewPatientModal() {
    var modal = document.getElementById("modal-overlay");
    var content = document.getElementById("modal-content");
    var html = "<div class='modal-title'>新規患者登録</div>";
    html += "<div style='height:400px; overflow-y:auto; padding-right:10px;'>";
    html += "<div class='form-group'><label class='form-label'>患者ID / カルテ番号</label><input class='form-input' id='np_pid'></div>";
    html += "<div class='form-group'><label class='form-label'>氏名</label><input class='form-input' id='np_name'></div>";
    html += "<div class='form-group'><label class='form-label'>氏名（カナ）</label><input class='form-input' id='np_kana'></div>";
    html += "<div class='form-group'><label class='form-label'>生年月日</label><input class='form-input' type='date' id='np_birth'></div>";
    html += "<div class='form-group'><label class='form-label'>性別</label><select class='form-input' id='np_sex'><option>男</option><option>女</option></select></div>";
    html += "<hr style='margin:15px 0; border:0; border-top:1px solid #eee;'>";
    html += "<div class='form-group'><label class='form-label'>郵便番号</label><input class='form-input' id='np_zip'></div>";
    html += "<div class='form-group'><label class='form-label'>住所</label><input class='form-input' id='np_addr'></div>";
    html += "<div class='form-group'><label class='form-label'>電話番号</label><input class='form-input' id='np_tel'></div>";
    html += "<hr style='margin:15px 0; border:0; border-top:1px solid #eee;'>";
    html += "<div class='form-group'><label class='form-label'>MRI対応</label><select class='form-input' id='np_mri'><option>Yes</option><option>No</option></select></div>";
    html += "<div class='form-group'><label class='form-label'>RMS導入</label><select class='form-input' id='np_rms_en'><option>Yes</option><option>No</option></select></div>";
    html += "<div class='form-group'><label class='form-label'>遠隔送信機の種類</label><input class='form-input' id='np_rms_type'></div>";
    html += "</div>";
    html += "<div style='text-align:right; margin-top:20px;'><button class='btn btn-secondary' onclick='closeModal()'>キャンセル</button> <button class='btn btn-primary' onclick='savePatient()'>保存</button></div>";
    content.innerHTML = html;
    modal.style.display = "flex";
}
function saveDevice() {
    if (!gCurrentPID) return;
    if (!acquireLock()) { alert("他のユーザーが編集中です。"); return; }
    var excel = null; var book = null;
    try {
        excel = new ActiveXObject("Excel.Application");
        book = excel.Workbooks.Open(gDbPath);
        var sheet = book.Sheets("T_DeviceConfig");
        var lastRow = sheet.UsedRange.Rows.Count + 1;
        
        var fields = [
            "dv_implant_date", "dv_implant_hosp", 
            "dv_phys_p1", "dv_phys_p2", "dv_phys_p3",
            "dv_phys_o1", "dv_phys_o2", "dv_phys_o3",
            "dv_summary", "dv_type", "dv_manuf", "dv_model", "dv_serial", "dv_site", "dv_comment",
            "dv_a_manuf", "dv_a_model", "dv_a_len", "dv_a_site", "dv_a_serial", "dv_a_comment",
            "dv_rv_manuf", "dv_rv_model", "dv_rv_len", "dv_rv_site", "dv_rv_serial", "dv_rv_shock", "dv_rv_comment",
            "dv_lv_manuf", "dv_lv_model", "dv_lv_len", "dv_lv_site", "dv_lv_serial", "dv_lv_port", "dv_lv_comment"
        ];
        
        sheet.Cells(lastRow, 1).Value = "C" + (new Date().getTime());
        sheet.Cells(lastRow, 2).Value = gCurrentPID;
        for(var i=0; i<fields.length; i++) {
            var val = document.getElementById(fields[i]).value;
            sheet.Cells(lastRow, i + 3).Value = val;
        }
        sheet.Cells(lastRow, 38).Value = "Active";

        book.Save();
        book.Close();
        excel.Quit();
        closeModal();
        releaseLock();
        alert("デバイス情報を登録しました。");
        loadAllData();
    } catch(e) {
        if(book) book.Close(false); if(excel) excel.Quit();
        releaseLock(); alert("エラー: " + e.message);
    }
}

function showDeviceModal() {
    if (!gCurrentPID) { alert("患者を選択してください。"); return; }
    var modal = document.getElementById("modal-overlay");
    var content = document.getElementById("modal-content");
    content.className = "modal-box wide";
    
    var html = "<div class='modal-title'>デバイス情報登録</div>";
    html += "<div style='height:500px; overflow-y:auto; padding-right:10px;'>";
    html += "<div class='form-grid'>";
    
    html += "<div class='form-section-title'>＃手術基本情報</div>";
    html += "<div class='form-group'><label class='form-label'>植込み日</label><input type='date' class='form-input' id='dv_implant_date'></div>";
    html += "<div class='form-group'><label class='form-label'>植込み病院</label><input class='form-input' id='dv_implant_hosp'></div>";
    html += "<div class='form-group'><label class='form-label'>主治医1</label><input class='form-input' id='dv_phys_p1'></div>";
    html += "<div class='form-group'><label class='form-label'>主治医2</label><input class='form-input' id='dv_phys_p2'></div>";
    html += "<div class='form-group'><label class='form-label'>主治医3</label><input class='form-input' id='dv_phys_p3'></div>";
    html += "<div class='form-group'><label class='form-label'>手術医1</label><input class='form-input' id='dv_phys_o1'></div>";
    html += "<div class='form-group'><label class='form-label'>手術医2</label><input class='form-input' id='dv_phys_o2'></div>";
    html += "<div class='form-group'><label class='form-label'>手術医3</label><input class='form-input' id='dv_phys_o3'></div>";
    html += "<div class='form-group' style='grid-column: span 2;'><label class='form-label'>手術サマリー</label><textarea class='form-input' id='dv_summary' style='height:60px;'></textarea></div>";

    html += "<div class='form-section-title'>＃本体情報</div>";
    html += "<div class='form-group'><label class='form-label'>デバイス種類</label><select class='form-input' id='dv_type'><option>PM (1ch)</option><option>PM (2ch)</option><option>ICD (1ch)</option><option>ICD (2ch)</option><option>CRTP</option><option>CRTD</option><option>S-ICD</option><option>Leadless PM</option></select></div>";
    html += "<div class='form-group'><label class='form-label'>メーカー名</label><input class='form-input' id='dv_manuf'></div>";
    html += "<div class='form-group'><label class='form-label'>モデルNo</label><input class='form-input' id='dv_model'></div>";
    html += "<div class='form-group'><label class='form-label'>シリアルNo</label><input class='form-input' id='dv_serial'></div>";
    html += "<div class='form-group'><label class='form-label'>植込み部位</label><input class='form-input' id='dv_site'></div>";
    html += "<div class='form-group' style='grid-column: span 2;'><label class='form-label'>コメント欄</label><input class='form-input' id='dv_comment'></div>";

    html += "<div class='form-section-title'>＃A lead情報</div>";
    html += "<div class='form-group'><label class='form-label'>メーカー名</label><input class='form-input' id='dv_a_manuf'></div>";
    html += "<div class='form-group'><label class='form-label'>モデルNo</label><input class='form-input' id='dv_a_model'></div>";
    html += "<div class='form-group'><label class='form-label'>リード長</label><input class='form-input' id='dv_a_len'></div>";
    html += "<div class='form-group'><label class='form-label'>植込み部位</label><input class='form-input' id='dv_a_site'></div>";
    html += "<div class='form-group'><label class='form-label'>シリアルNo</label><input class='form-input' id='dv_a_serial'></div>";
    html += "<div class='form-group'><label class='form-label'>コメント欄</label><input class='form-input' id='dv_a_comment'></div>";

    html += "<div class='form-section-title'>＃RV lead情報</div>";
    html += "<div class='form-group'><label class='form-label'>メーカー名</label><input class='form-input' id='dv_rv_manuf'></div>";
    html += "<div class='form-group'><label class='form-label'>モデルNo</label><input class='form-input' id='dv_rv_model'></div>";
    html += "<div class='form-group'><label class='form-label'>リード長</label><input class='form-input' id='dv_rv_len'></div>";
    html += "<div class='form-group'><label class='form-label'>植込み部位</label><input class='form-input' id='dv_rv_site'></div>";
    html += "<div class='form-group'><label class='form-label'>シリアルNo</label><input class='form-input' id='dv_rv_serial'></div>";
    html += "<div class='form-group'><label class='form-label'>ショックリード形状</label><select class='form-input' id='dv_rv_shock'><option>-</option><option>DF1 / Single coil</option><option>DF1 / Dual coil</option><option>DF4 / Single coil</option><option>DF4 / Dual coil</option></select></div>";
    html += "<div class='form-group' style='grid-column: span 2;'><label class='form-label'>コメント欄</label><input class='form-input' id='dv_rv_comment'></div>";

    html += "<div class='form-section-title'>＃LV lead情報</div>";
    html += "<div class='form-group'><label class='form-label'>メーカー名</label><input class='form-input' id='dv_lv_manuf'></div>";
    html += "<div class='form-group'><label class='form-label'>モデルNo</label><input class='form-input' id='dv_lv_model'></div>";
    html += "<div class='form-group'><label class='form-label'>リード長</label><input class='form-input' id='dv_lv_len'></div>";
    html += "<div class='form-group'><label class='form-label'>植込み部位</label><input class='form-input' id='dv_lv_site'></div>";
    html += "<div class='form-group'><label class='form-label'>シリアルNo</label><input class='form-input' id='dv_lv_serial'></div>";
    html += "<div class='form-group'><label class='form-label'>リード形状</label><select class='form-input' id='dv_lv_port'><option>-</option><option>IS-1</option><option>IS-4</option></select></div>";
    html += "<div class='form-group' style='grid-column: span 2;'><label class='form-label'>コメント欄</label><input class='form-input' id='dv_lv_comment'></div>";

    html += "</div></div>";
    html += "<div style='text-align:right; margin-top:20px;'><button class='btn btn-secondary' onclick='closeModal()'>キャンセル</button> <button class='btn btn-primary' onclick='saveDevice()'>保存</button></div>";
    content.innerHTML = html;
    modal.style.display = "flex";
}
function closeModal() { document.getElementById("modal-overlay").style.display = "none"; document.getElementById("modal-content").className = "modal-box"; }
function showSettingsModal() { alert("未実装"); }
function showMeasurementModal() { alert("未実装"); }

function showDeviceDetailModal(configID) {
    var d = null;
    for(var i=0; i<gDevices.length; i++) {
        if(gDevices[i].ConfigID == configID) { d = gDevices[i]; break; }
    }
    if(!d) return;

    var modal = document.getElementById("modal-overlay");
    var content = document.getElementById("modal-content");
    content.className = "modal-box wide";
    
    var html = "<div class='modal-title'>デバイス詳細情報</div>";
    html += "<div style='height:450px; overflow-y:auto; padding-right:10px;'>";
    html += "<div class='form-grid'>";
    
    function addDetail(label, val) {
        return "<div class='form-group'><label class='form-label'>" + label + "</label><div style='padding:8px; background:#f8fafc; border-radius:4px; border:1px solid #e2e8f0; font-size:13px;'>" + (val || "-") + "</div></div>";
    }

    html += "<div class='form-section-title'>＃手術基本情報</div>";
    html += addDetail("植込み日", d.ImplantDate);
    html += addDetail("植込み病院", d.ImplantHospital);
    html += addDetail("主治医1", d.PhysicianPrimary1);
    html += addDetail("主治医2", d.PhysicianPrimary2);
    html += addDetail("主治医3", d.PhysicianPrimary3);
    html += addDetail("手術医1", d.PhysicianOperator1);
    html += addDetail("手術医2", d.PhysicianOperator2);
    html += addDetail("手術医3", d.PhysicianOperator3);
    html += "<div class='form-group' style='grid-column: span 2;'><label class='form-label'>手術サマリー</label><div style='padding:8px; background:#f8fafc; border-radius:4px; border:1px solid #e2e8f0; font-size:13px; min-height:60px; white-space:pre-wrap;'>" + (d.SurgerySummary || "-") + "</div></div>";

    html += "<div class='form-section-title'>＃本体情報</div>";
    html += addDetail("デバイス種類", d.DeviceType);
    html += addDetail("メーカー名", d.Manufacturer);
    html += addDetail("モデルNo", d.ModelNumber);
    html += addDetail("シリアルNo", d.SerialNumber);
    html += addDetail("植込み部位", d.ImplantSite);
    html += "<div class='form-group' style='grid-column: span 2;'><label class='form-label'>コメント欄</label><div style='padding:8px; background:#f8fafc; border-radius:4px; border:1px solid #e2e8f0; font-size:13px;'>" + (d.GeneratorComment || "-") + "</div></div>";

    html += "<div class='form-section-title'>＃A lead情報</div>";
    html += addDetail("メーカー名", d.ALeadManufacturer);
    html += addDetail("モデルNo", d.ALeadModel);
    html += addDetail("リード長", d.ALeadLength);
    html += addDetail("植込み部位", d.ALeadSite);
    html += addDetail("シリアルNo", d.ALeadSerial);
    html += addDetail("コメント欄", d.ALeadComment);

    html += "<div class='form-section-title'>＃RV lead情報</div>";
    html += addDetail("メーカー名", d.RVLeadManufacturer);
    html += addDetail("モデルNo", d.RVLeadModel);
    html += addDetail("リード長", d.RVLeadLength);
    html += addDetail("植込み部位", d.RVLeadSite);
    html += addDetail("シリアルNo", d.RVLeadSerial);
    html += addDetail("ショックリード形状", d.RVLeadShockType);
    html += "<div class='form-group' style='grid-column: span 2;'><label class='form-label'>コメント欄</label><div style='padding:8px; background:#f8fafc; border-radius:4px; border:1px solid #e2e8f0; font-size:13px;'>" + (d.RVLeadComment || "-") + "</div></div>";

    html += "<div class='form-section-title'>＃LV lead情報</div>";
    html += addDetail("メーカー名", d.LVLeadManufacturer);
    html += addDetail("モデルNo", d.LVLeadModel);
    html += addDetail("リード長", d.LVLeadLength);
    html += addDetail("植込み部位", d.LVLeadSite);
    html += addDetail("シリアルNo", d.LVLeadSerial);
    html += addDetail("リード形状", d.LVLeadPortType);
    html += "<div class='form-group' style='grid-column: span 2;'><label class='form-label'>コメント欄</label><div style='padding:8px; background:#f8fafc; border-radius:4px; border:1px solid #e2e8f0; font-size:13px;'>" + (d.LVLeadComment || "-") + "</div></div>";

    html += "</div></div>";
    html += "<div style='text-align:right; margin-top:20px;'><button class='btn btn-primary' onclick='closeModal()'>閉じる</button></div>";
    content.innerHTML = html;
    modal.style.display = "flex";
}
</script>
</head>
<body>
<div id="sidebar-panel">
    <div class="sidebar-header">
        <button id="btn-list" class="sidebar-tab active" onclick="showTab('list')">リスト</button>
        <button id="btn-info" class="sidebar-tab" onclick="showTab('info')">基本情報</button>
    </div>
    <div id="tab-list" class="sidebar-content active">
        <input type="text" class="search-box" id="search-box" onkeyup="filterList()" placeholder="検索...">
        <div id="status-msg" style="color:#fcd34d; font-size:12px; margin-bottom:5px;">Loading...</div>
        <div id="patient-list-container"></div>
        <div style="margin-top:20px; padding-top:20px; border-top:1px solid #334155;">
            <button class="btn btn-primary btn-block" onclick="showNewPatientModal()">＋ 新規患者登録</button>
        </div>
    </div>
    <div id="tab-info" class="sidebar-content"><div id="patient-detail-container"></div></div>
</div>
<div id="main-panel">
    <div class="main-header">
        <div class="app-title"> CIEDs 患者管理システム <span id="loading-indicator" class="loader">通信中...</span></div>
        <div id="current-patient-name" class="current-patient-name"></div>
    </div>
    <div class="cards-area">
        <div class="card"><div class="card-header blue"><div class="card-title">デバイス情報</div><button class="btn btn-secondary" onclick="showDeviceModal()">追加</button></div><div class="card-body" id="device-body"></div></div>
        <div class="card"><div class="card-header green"><div class="card-title">設定情報</div><button class="btn btn-secondary" onclick="showSettingsModal()">追加</button></div><div class="card-body" id="settings-body"></div></div>
        <div class="card"><div class="card-header yellow"><div class="card-title">測定情報</div><button class="btn btn-secondary" onclick="showMeasurementModal()">追加</button></div><div class="card-body" id="measurement-body"></div></div>
    </div>
</div>
<div id="modal-overlay" class="modal-overlay"><div id="modal-content" class="modal-box"></div></div>
</body>
</html>

