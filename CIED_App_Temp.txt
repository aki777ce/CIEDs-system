<html>
<head>
<title>CIEDs Patient Management System</title>
<HTA:APPLICATION
    ID="CIEDApp"
    APPLICATIONNAME="CIEDsSystem"
    BORDER="thick"
    BORDERSTYLE="normal"
    CAPTION="yes"
    ICON=""
    MAXIMIZEBUTTON="yes"
    MINIMIZEBUTTON="yes"
    SHOWINTASKBAR="yes"
    SINGLEINSTANCE="yes"
    SYSMENU="yes"
    VERSION="3.2"
    WINDOWSTATE="maximize"
    NAVIGABLE="yes"
/>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta charset="Shift_JIS">
<style>
/* Reset & Base */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: 'Meiryo', 'Segoe UI', sans-serif; 
    background-color: #f8fafc; 
    color: #333; 
    height: 100vh; 
    width: 100vw;
    overflow: hidden; 
}
button, input, select, textarea { font-family: inherit; }

/* Layout */
#sidebar-panel {
    position: absolute;
    top: 0; left: 0; bottom: 0;
    width: 320px;
    background-color: #1e293b;
    border-right: 1px solid #475569;
    z-index: 10;
    display: flex;
    flex-direction: column;
}
#main-panel {
    position: absolute;
    top: 0; left: 320px; right: 0; bottom: 0;
    background-color: #f8fafc;
    display: flex;
    flex-direction: column;
}

/* Sidebar Elements */
.sidebar-header {
    height: 50px;
    background-color: #0f172a;
    display: flex;
}
.sidebar-tab {
    flex: 1;
    background: transparent;
    color: #94a3b8;
    border: none;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
}
.sidebar-tab:hover { background: rgba(255,255,255,0.05); }
.sidebar-tab.active {
    color: #fff;
    background: #1e293b;
    border-bottom: 3px solid #3b82f6;
}

.sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    display: none;
}
.sidebar-content.active { display: block; }

.search-box {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    background: #334155;
    border: 1px solid #475569;
    color: #fff;
    border-radius: 4px;
}

.patient-list-item {
    padding: 12px;
    border-bottom: 1px solid #334155;
    cursor: pointer;
    transition: background 0.1s;
}
.patient-list-item:hover { background-color: #334155; }
.patient-list-item.selected { background-color: #2563eb; border-left: 4px solid #60a5fa; }
.pt-name { font-weight: bold; font-size: 15px; color: #f1f5f9; }
.pt-id { font-size: 12px; color: #94a3b8; }

/* Detail View */
.detail-table { width: 100%; }
.detail-table td { border-bottom: 1px solid #334155; padding: 10px 0; }
.detail-table tr:hover { background: transparent; }
.detail-label { display: block; font-size: 11px; color: #94a3b8; margin-bottom: 2px; }
.detail-value { font-size: 14px; color: #f1f5f9; font-weight: 500; }

/* Main Panel Elements */
.main-header {
    height: 64px;
    background: #fff;
    border-bottom: 1px solid #e2e8f0;
    padding: 0 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.app-title { font-size: 18px; color: #0f172a; font-weight: bold; display: flex; align-items: center; gap: 10px; }
.loader { display:none; font-size:12px; color:#2563eb; margin-left:10px; font-weight:normal; }
.current-patient-name { font-size: 18px; color: #2563eb; font-weight: bold; }

.cards-area {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}

.card {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    overflow: hidden;
}
.card-header {
    padding: 12px 20px;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    font-weight: bold;
    color: #1e293b;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.card-title { display: flex; align-items: center; gap: 8px; }
.card-header.blue { border-left: 4px solid #3b82f6; background: linear-gradient(to right, #eff6ff, #fff); }
.card-header.green { border-left: 4px solid #22c55e; background: linear-gradient(to right, #f0fdf4, #fff); }
.card-header.yellow { border-left: 4px solid #eab308; background: linear-gradient(to right, #fefce8, #fff); }

.card-body { padding: 0; overflow-x: auto; }
.empty-msg { padding: 30px; text-align: center; color: #94a3b8; }
.empty-msg.error { color: #fef2f2; background: #b91c1c; border: 1px solid #991b1b; padding: 15px; border-radius: 4px; text-align: left; font-size: 12px; white-space: pre-wrap; word-break: break-all; }

/* Tables */
table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 600px; }
th { background: #f8fafc; color: #64748b; padding: 10px 15px; text-align: left; font-weight: 600; border-bottom: 1px solid #e2e8f0; white-space: nowrap; }
td { padding: 10px 15px; border-bottom: 1px solid #f1f5f9; color: #334155; white-space: nowrap; }
.card-body tr:hover { background: #f8fafc; }
.status-active { color: #16a34a; font-weight: bold; background: #dcfce7; padding: 2px 8px; border-radius: 10px; font-size: 11px; }
.status-old { color: #64748b; background: #f1f5f9; padding: 2px 8px; border-radius: 10px; font-size: 11px; }

/* Forms & Modals */
.btn { padding: 6px 14px; border-radius: 5px; cursor: pointer; border: none; font-size: 13px; font-weight: 500; transition: background 0.1s; }
.btn-primary { background: #2563eb; color: #fff; }
.btn-primary:hover { background: #1d4ed8; }
.btn-secondary { background: #fff; color: #475569; border: 1px solid #cbd5e1; }
.btn-secondary:hover { background: #f1f5f9; border-color: #94a3b8; }
.btn-block { width: 100%; display: block; margin-bottom: 10px; padding: 10px; }

.modal-overlay {
    display: none;
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(15,23,42,0.7);
    z-index: 100;
    align-items: center; justify-content: center;
}
.modal-box {
    background: #fff; width: 500px; max-width: 90%;
    padding: 25px; border-radius: 12px;
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
}
.modal-box.wide { width: 800px; }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.form-section-title { grid-column: 1 / span 2; font-weight: bold; padding: 10px 0; border-bottom: 2px solid #e2e8f0; margin-top: 10px; color: #1e293b; }
.modal-title { font-size: 18px; font-weight: bold; margin-bottom: 20px; color: #0f172a; }
.form-group { margin-bottom: 15px; }
.form-label { display: block; font-size: 13px; font-weight: bold; color: #475569; margin-bottom: 5px; }
.form-input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; }

/* Detail Page UI */
#brief-view { display: block; }
#detail-view { display: none; flex: 1; padding: 25px; overflow-y: auto; background: #f1f5f9; }
.detail-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
.detail-columns { display: flex; gap: 20px; align-items: flex-start; }
.detail-column { flex: 1; display: flex; flex-direction: column; gap: 20px; min-width: 320px; }
.detail-section-card { background: #fff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; border: 1px solid #e2e8f0; }
.detail-section-header { padding: 12px 15px; color: #fff; font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 8px; }
.detail-section-header.surgery { background: linear-gradient(135deg, #1e293b, #334155); }
.detail-section-header.device { background: linear-gradient(135deg, #2563eb, #3b82f6); }
.detail-section-header.lead-a { background: linear-gradient(135deg, #059669, #10b981); }
.detail-section-header.lead-rv { background: linear-gradient(135deg, #b91c1c, #dc2626); }
.detail-section-header.lead-lv { background: linear-gradient(135deg, #d97706, #f59e0b); }
.detail-section-body { padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.full-width { grid-column: span 2; }
@media (max-width: 1200px) { .detail-columns { flex-wrap: wrap; } .detail-column { flex: 1 1 45%; } }
</style>

<script language="JavaScript">
// Global Data
var gDbPath = "";
var gLockPath = "";
var gCurrentPID = "";
var gPatients = [];
var gDevices = [];
var gSettings = [];
var gMeasurements = [];

var MAX_RETRIES = 5;
var RETRY_DELAY_MS = 1000;

// Initialize
window.onload = function() {
    try {
        setTimeout(function() {
            window.moveTo(0, 0);
            window.resizeTo(screen.availWidth, screen.availHeight);
        }, 100);

        var fso = new ActiveXObject("Scripting.FileSystemObject");
        var path = document.location.pathname;
        path = path.replace(/\//g, "\\");
        if (path.substring(0, 1) == "\\") path = path.substring(1); 
        gDbPath = fso.GetParentFolderName(path) + "\\CIED_DB.xlsx";
        gLockPath = fso.GetParentFolderName(path) + "\\CIED_DB.lock";
        
        if (!fso.FileExists(gDbPath)) {
            document.getElementById("patient-list-container").innerHTML = "<div class='empty-msg error'>繝輔ぃ繧､繝ｫ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ:<br>" + gDbPath + "</div>";
            return;
        }

        loadAllData();
        
    } catch(e) {
        document.getElementById("patient-list-container").innerHTML = "<div class='empty-msg error'>襍ｷ蜍輔お繝ｩ繝ｼ:<br>" + e.message + "</div>";
    }
};

function setStatus(msg) {
    document.getElementById("status-msg").innerText = msg;
    var ind = document.getElementById("loading-indicator");
    if(msg.indexOf("...") > -1) {
        ind.style.display = "inline";
    } else {
        ind.style.display = "none";
    }
}

// --- Excel Automation (Read) ---
function loadAllData() {
    setStatus("繝・・繧ｿ蜷梧悄荳ｭ...");
    
    var excel = null;
    var book = null;
    try {
        excel = new ActiveXObject("Excel.Application");
        excel.Visible = false;
        excel.DisplayAlerts = false;
        
        book = excel.Workbooks.Open(gDbPath, 0, true); 
        
        gPatients = readSheetData(book.Sheets("T_Patients"));
        gDevices = readSheetData(book.Sheets("T_DeviceConfig"));
        gSettings = readSheetData(book.Sheets("T_Settings"));
        gMeasurements = readSheetData(book.Sheets("T_Measurements"));
        
        book.Close(false);
        excel.Quit();
        excel = null;
        
        renderPatientList();
        
    } catch(e) {
        if(book) { try{book.Close(false);}catch(e2){} }
        if(excel) { try{excel.Quit();}catch(e2){} }
        document.getElementById("patient-list-container").innerHTML = "<div class='empty-msg error'>隱ｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ:<br>" + e.message + "</div>";
        setStatus("");
    }
}

function readSheetData(sheet) {
    var data = [];
    try {
        var usedRange = sheet.UsedRange;
        var rowCount = usedRange.Rows.Count;
        var colCount = usedRange.Columns.Count;
        
        if (rowCount <= 1) return [];
        
        var vArray = new VBArray(usedRange.Value).toArray();
        var headers = [];
        for(var c=1; c<=colCount; c++) {
            var idx = (c - 1) * rowCount;
            headers.push(vArray[idx]); 
        }
        
        for(var r=2; r<=rowCount; r++) {
            var rowObj = {};
            var hasData = false;
            for(var c=1; c<=colCount; c++) {
                var idx = (c - 1) * rowCount + (r - 1);
                var val = vArray[idx];
                var key = headers[c-1];
                
                if (val !== undefined && val !== null) {
                    rowObj[key] = formatDate(key, val);
                    if (val !== "") hasData = true;
                } else {
                    rowObj[key] = "";
                }
            }
            if(hasData) data.push(rowObj);
        }
    } catch(e) { }
    return data;
}

function formatDate(key, val) {
    // Only format if the column name implies a date, or if its a Date object
    var dateKeys = ["BirthDate", "RegistrationDate", "ImplantDate", "SettingDate", "MeasureDate"];
    var isDateKey = false;
    for(var i=0; i<dateKeys.length; i++) { if(key == dateKeys[i]) isDateKey = true; }
    
    if(!isDateKey) return val + "";

    try {
        var d = new Date(val);
        if(!isNaN(d) && d.getFullYear() > 1900) {
             var y = d.getFullYear();
             var m = d.getMonth() + 1;
             var dd = d.getDate();
             return y + "/" + (m<10?"0"+m:m) + "/" + (dd<10?"0"+dd:dd);
        }
    } catch(e){}
    return val + "";
}

// --- Logic ---
function showTab(mode) {
    document.getElementById('btn-list').className = 'sidebar-tab' + (mode=='list'?' active':'');
    document.getElementById('btn-info').className = 'sidebar-tab' + (mode=='info'?' active':'');
    document.getElementById('tab-list').className = 'sidebar-content' + (mode=='list'?' active':'');
    document.getElementById('tab-info').className = 'sidebar-content' + (mode=='info'?' active':'');
    if(mode == 'list') filterList();
}

function renderPatientList() {
    var container = document.getElementById("patient-list-container");
    var html = "";
    var count = 0;
    for(var i=0; i<gPatients.length; i++) {
        var p = gPatients[i];
        if(!p["Name"]) continue;
        html += "<div class='patient-list-item' pid='" + p["PatientID"] + "' onclick='selectPatient(\"" + p["PatientID"] + "\")'>";
        html += "<div class='pt-name'>" + p["Name"] + " (" + (p["NameKana"] || "") + ")</div>";
        html += "<div class='pt-id'>" + p["PatientID"] + "</div>";
        html += "</div>";
        count++;
    }
    if (count === 0) html = "<div class='empty-msg'>繝・・繧ｿ縺ｪ縺・/div>";
    container.innerHTML = html;
    setStatus(count + " 莉ｶ");
}

function calculateAge(birthDateStr) {
    if (!birthDateStr) return "-";
    try {
        var birthDate = new Date(birthDateStr);
        if (isNaN(birthDate)) return "-";
        var today = new Date();
        var age = today.getFullYear() - birthDate.getFullYear();
        var m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
        return age + "豁ｳ";
    } catch(e) { return "-"; }
}

function selectPatient(pid) {
    gCurrentPID = pid;
    var items = document.getElementsByClassName("patient-list-item");
    for(var i=0; i<items.length; i++) {
        items[i].className = "patient-list-item";
        if(items[i].getAttribute("pid") == pid) items[i].className += " selected";
    }
    
    var p = null;
    for(var i=0; i<gPatients.length; i++) {
        if(gPatients[i]["PatientID"] == pid) { p = gPatients[i]; break; }
    }
    
    if (p) {
        var html = "<div style='text-align:center; padding:20px 0;'>";
        html += "<div style='font-size:18px; font-weight:bold; color:#fff;'>" + (p["Name"] || "No Name") + "</div>";
        html += "</div>";
        html += "<table class='detail-table'>";
        html += "<tr><td><span class='detail-label'>謔｣閠・D / 繧ｫ繝ｫ繝・分蜿ｷ</span><span class='detail-value'>" + (p["PatientID"] || "-") + "</span></td></tr>";
        html += "<tr><td><span class='detail-label'>豌丞錐 (繧ｫ繝・</span><span class='detail-value'>" + (p["Name"] || "-") + " (" + (p["NameKana"] || "-") + ")</span></td></tr>";
        html += "<tr><td><span class='detail-label'>諤ｧ蛻･ / 逕溷ｹｴ譛域律</span><span class='detail-value'>" + (p["Sex"] || "-") + " / " + (p["BirthDate"] || "-") + " (" + calculateAge(p["BirthDate"]) + ")</span></td></tr>";
        html += "<tr><td><span class='detail-label'>菴乗園</span><span class='detail-value'>縲・ + (p["PostalCode"] || "-") + "<br>" + (p["Address"] || "-") + "</span></td></tr>";
        html += "<tr><td><span class='detail-label'>髮ｻ隧ｱ逡ｪ蜿ｷ</span><span class='detail-value'>" + (p["Phone"] || "-") + "</span></td></tr>";
        html += "<tr><td><span class='detail-label'>MRI蟇ｾ蠢・/span><span class='detail-value'>" + (p["MRICompatible"] || "-") + "</span></td></tr>";
        html += "<tr><td><span class='detail-label'>RMS蟆主・ / 騾∽ｿ｡讖・/span><span class='detail-value'>" + (p["RMS_Enabled"] || "No") + " / " + (p["RMS_TransmitterType"] || "-") + "</span></td></tr>";
        html += "<tr><td><span class='detail-label'>逋ｻ骭ｲ譌･</span><span class='detail-value'>" + (p["RegistrationDate"] || "-") + "</span></td></tr>";
        html += "</table>";
        
        document.getElementById("patient-detail-container").innerHTML = html;
        document.getElementById("current-patient-name").innerText = (p["Name"] || "") + " 讒・;
        
        renderSubData(gDevices, "PatientID", pid, "device-body", 
            ["ImplantDate", "Manufacturer", "ModelNumber", "DeviceType", "SerialNumber", "ImplantSite", "ImplantHospital", "Status"],
            ["讀崎ｾｼ縺ｿ譌･", "繝｡繝ｼ繧ｫ繝ｼ", "蝙狗分", "遞ｮ鬘・, "Serial", "驛ｨ菴・, "逞・劼", "迥ｶ諷・],
            "ConfigID");
        closeDeviceDetailPage();
        renderSubData(gSettings, "PatientID", pid, "settings-body", 
            ["SettingDate", "Mode", "LowerRate", "UpperRate", "AV_Delay"],
            ["險ｭ螳壽律", "Mode", "LRL", "URL", "AVD"]);
        renderSubData(gMeasurements, "PatientID", pid, "measurement-body", 
            ["MeasureDate", "Sensing_A", "Sensing_V", "Impedance_A", "Impedance_RV"],
            ["貂ｬ螳壽律", "Sense A", "Sense V", "Imp A", "Imp RV"]);
        showTab('info');
    }
}

function renderSubData(sourceArray, keyField, keyVal, targetId, keys, labels, idField) {
    if(!labels) labels = keys;
    var html = "<div class='empty-msg'>螻･豁ｴ縺ｪ縺・/div>";
    var rows = [];
    for(var i=0; i<sourceArray.length; i++) {
        if(sourceArray[i][keyField] == keyVal) rows.push(sourceArray[i]);
    }
    rows.sort(function(a,b){ return (a[keys[0]] < b[keys[0]]) ? 1 : -1; });
    
    if(rows.length > 0) {
        html = "<table><tr>";
        for(var h=0; h<labels.length; h++) html += "<th>"+labels[h]+"</th>";
        html += "</tr>";
        for(var i=0; i<rows.length; i++) {
            var rowAttr = idField ? " onclick='onRowClick(\"" + targetId + "\", \"" + rows[i][idField] + "\")' style='cursor:pointer'" : "";
            html += "<tr" + rowAttr + ">";
            for(var h=0; h<keys.length; h++) {
                var val = rows[i][keys[h]];
                var k = keys[h];
                if(k=="Status" || k=="繧ｹ繝・・繧ｿ繧ｹ") {
                    if(val=="Active") val = "<span class='status-active'>Active</span>";
                    else val = "<span class='status-old'>Old</span>";
                }
                html += "<td>" + (val || "") + "</td>";
            }
            html += "</tr>";
        }
        html += "</table>";
    }
    document.getElementById(targetId).innerHTML = html;
}

function onRowClick(targetId, id) {
    if(targetId == "device-body") showDeviceDetailPage(id);
}

function filterList() {
    var key = document.getElementById('search-box').value.toLowerCase();
    var items = document.getElementsByClassName("patient-list-item");
    for(var i=0; i<items.length; i++) {
        var text = items[i].innerText.toLowerCase();
        items[i].style.display = (text.indexOf(key) > -1) ? 'block' : 'none';
    }
}

function acquireLock() {
    var fso = new ActiveXObject("Scripting.FileSystemObject");
    if (fso.FileExists(gLockPath)) return false;
    try {
        var f = fso.CreateTextFile(gLockPath, false);
        f.WriteLine(new Date());
        f.Close();
        return true;
    } catch(e) { return false; }
}

function releaseLock() {
    var fso = new ActiveXObject("Scripting.FileSystemObject");
    if(fso.FileExists(gLockPath)) { try { fso.DeleteFile(gLockPath, true); } catch(e){} }
}

function savePatient() {
    if (!acquireLock()) { alert("莉悶・繝ｦ繝ｼ繧ｶ繝ｼ縺檎ｷｨ髮・ｸｭ縺ｧ縺吶・); return; }
    var excel = null; var book = null;
    try {
        var pid = document.getElementById('np_pid').value;
        var name = document.getElementById('np_name').value;
        var kana = document.getElementById('np_kana').value;
        var birth = document.getElementById('np_birth').value;
        var sex = document.getElementById('np_sex').value;
        var zip = document.getElementById('np_zip').value;
        var addr = document.getElementById('np_addr').value;
        var tel = document.getElementById('np_tel').value;
        var mri = document.getElementById('np_mri').value;
        var rms_en = document.getElementById('np_rms_en').value;
        var rms_type = document.getElementById('np_rms_type').value;

        excel = new ActiveXObject("Excel.Application");
        book = excel.Workbooks.Open(gDbPath);
        var sheet = book.Sheets("T_Patients");
        var lastRow = sheet.UsedRange.Rows.Count + 1;
        sheet.Cells(lastRow, 1).Value = pid;
        sheet.Cells(lastRow, 2).Value = name;
        sheet.Cells(lastRow, 3).Value = kana;
        sheet.Cells(lastRow, 4).Value = sex;
        sheet.Cells(lastRow, 5).Value = birth;
        sheet.Cells(lastRow, 6).Value = zip;
        sheet.Cells(lastRow, 7).Value = addr;
        sheet.Cells(lastRow, 8).Value = "'" + tel;
        sheet.Cells(lastRow, 9).Value = mri;
        sheet.Cells(lastRow, 10).Value = rms_en;
        sheet.Cells(lastRow, 11).Value = rms_type;
        sheet.Cells(lastRow, 12).Value = new Date().toLocaleDateString();
        
        book.Save();
        book.Close();
        excel.Quit();
        closeModal();
        releaseLock();
        alert("逋ｻ骭ｲ螳御ｺ・);
        loadAllData();
    } catch(e) {
        if(book) book.Close(false); if(excel) excel.Quit();
        releaseLock(); alert("繧ｨ繝ｩ繝ｼ: " + e.message);
    }
}

function showNewPatientModal() {
    var modal = document.getElementById("modal-overlay");
    var content = document.getElementById("modal-content");
    var html = "<div class='modal-title'>譁ｰ隕乗ぅ閠・匳骭ｲ</div>";
    html += "<div style='height:400px; overflow-y:auto; padding-right:10px;'>";
    html += "<div class='form-group'><label class='form-label'>謔｣閠・D / 繧ｫ繝ｫ繝・分蜿ｷ</label><input class='form-input' id='np_pid'></div>";
    html += "<div class='form-group'><label class='form-label'>豌丞錐</label><input class='form-input' id='np_name'></div>";
    html += "<div class='form-group'><label class='form-label'>豌丞錐・医き繝奇ｼ・/label><input class='form-input' id='np_kana'></div>";
    html += "<div class='form-group'><label class='form-label'>逕溷ｹｴ譛域律</label><input class='form-input' type='date' id='np_birth'></div>";
    html += "<div class='form-group'><label class='form-label'>諤ｧ蛻･</label><select class='form-input' id='np_sex'><option>逕ｷ</option><option>螂ｳ</option></select></div>";
    html += "<hr style='margin:15px 0; border:0; border-top:1px solid #eee;'>";
    html += "<div class='form-group'><label class='form-label'>驛ｵ萓ｿ逡ｪ蜿ｷ</label><input class='form-input' id='np_zip'></div>";
    html += "<div class='form-group'><label class='form-label'>菴乗園</label><input class='form-input' id='np_addr'></div>";
    html += "<div class='form-group'><label class='form-label'>髮ｻ隧ｱ逡ｪ蜿ｷ</label><input class='form-input' id='np_tel'></div>";
    html += "<hr style='margin:15px 0; border:0; border-top:1px solid #eee;'>";
    html += "<div class='form-group'><label class='form-label'>MRI蟇ｾ蠢・/label><select class='form-input' id='np_mri'><option>Yes</option><option>No</option></select></div>";
    html += "<div class='form-group'><label class='form-label'>RMS蟆主・</label><select class='form-input' id='np_rms_en'><option>Yes</option><option>No</option></select></div>";
    html += "<div class='form-group'><label class='form-label'>驕髫秘∽ｿ｡讖溘・遞ｮ鬘・/label><input class='form-input' id='np_rms_type'></div>";
    html += "</div>";
    html += "<div style='text-align:right; margin-top:20px;'><button class='btn btn-secondary' onclick='closeModal()'>繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button> <button class='btn btn-primary' onclick='savePatient()'>菫晏ｭ・/button></div>";
    content.innerHTML = html;
    modal.style.display = "flex";
}
function showDeviceModal() {
    showDeviceDetailPage(null);
}

var gCurrentConfigID = null;

function showDeviceDetailPage(configID) {
    if (!gCurrentPID) { alert("謔｣閠・ｒ驕ｸ謚槭＠縺ｦ縺上□縺輔＞縲・); return; }
    gCurrentConfigID = configID;
    
    var d = null;
    if(configID) {
        for(var i=0; i<gDevices.length; i++) {
            if(gDevices[i].ConfigID == configID) { d = gDevices[i]; break; }
        }
    }

    document.getElementById("brief-view").style.display = "none";
    var detailView = document.getElementById("detail-view");
    detailView.style.display = "block";
    
    var html = "<div class='detail-header'>";
    html += "<div style='display:flex; align-items:center; gap:15px;'>";
    html += "<button class='btn btn-secondary' onclick='closeDeviceDetailPage()'>竊・謌ｻ繧・/button>";
    html += "<h2 style='color:#0f172a;'>" + (configID ? "繝・ヰ繧､繧ｹ隧ｳ邏ｰ繝ｻ邱ｨ髮・ : "譁ｰ隕上ョ繝舌う繧ｹ逋ｻ骭ｲ") + "</h2>";
    html += "</div>";
    html += "<button class='btn btn-primary' style='padding:10px 25px; font-size:15px;' onclick='saveDevice()'>菫晏ｭ倥☆繧・/button>";
    html += "</div>";

     html += "<div class='detail-columns'>";

    function field(id, label, val, type) {
        var input = "";
        if(type == "textarea") {
            var h = (id == "dv_summary") ? "320px" : "60px";
            input = "<textarea class='form-input' id='" + id + "' style='height:" + h + "; font-size:12px;'>" + (val || "") + "</textarea>";
        } else if(type == "select") {
            input = "<select class='form-input' id='" + id + "' style='font-size:12px; padding:6px;'>";
            var opts = arguments[4];
            for(var o=0; o<opts.length; o++) {
                var sel = (val == opts[o] ? " selected" : "");
                input += "<option" + sel + ">" + opts[o] + "</option>";
            }
            input += "</select>";
        } else {
            input = "<input class='form-input' id='" + id + "' type='" + (type || "text") + "' value='" + (val || "") + "' style='font-size:12px; padding:6px;'>";
        }
        return "<div class='form-group' style='margin-bottom:8px;'><label class='form-label' style='font-size:11px; margin-bottom:2px;'>" + label + "</label>" + input + "</div>";
    }

    // Column 1: Surgery
    html += "<div class='detail-column'>";
    html += "<div class='detail-section-card' style='height:100%; display:flex; flex-direction:column;'>";
    html += "<div class='detail-section-header surgery'>・・焔陦灘渕譛ｬ諠・ｱ</div>";
    html += "<div class='detail-section-body' style='flex:1;'>";
    html += field("dv_implant_date", "讀崎ｾｼ縺ｿ譌･", d ? d.ImplantDate : "", "date");
    html += field("dv_implant_hosp", "讀崎ｾｼ縺ｿ逞・劼", d ? d.ImplantHospital : "");
    html += field("dv_phys_p1", "荳ｻ豐ｻ蛹ｻ1", d ? d.PhysicianPrimary1 : "");
    html += field("dv_phys_p2", "荳ｻ豐ｻ蛹ｻ2", d ? d.PhysicianPrimary2 : "");
    html += field("dv_phys_p3", "荳ｻ豐ｻ蛹ｻ3", d ? d.PhysicianPrimary3 : "");
    html += field("dv_phys_o1", "謇玖｡灘現1", d ? d.PhysicianOperator1 : "");
    html += field("dv_phys_o2", "謇玖｡灘現2", d ? d.PhysicianOperator2 : "");
    html += field("dv_phys_o3", "謇玖｡灘現3", d ? d.PhysicianOperator3 : "");
    html += "<div class='full-width' style='flex:1;'>" + field("dv_summary", "謇玖｡薙し繝槭Μ繝ｼ", d ? d.SurgerySummary : "", "textarea") + "</div>";
    html += "</div></div>";
    html += "</div>"; // end column 1

    // Column 2: Device & RV Lead
    html += "<div class='detail-column'>";
    html += "<div class='detail-section-card'>";
    html += "<div class='detail-section-header device'>・・悽菴捺ュ蝣ｱ</div>";
    html += "<div class='detail-section-body'>";
    html += field("dv_type", "遞ｮ鬘・, d ? d.DeviceType : "", "select", ["PM (1ch)","PM (2ch)","ICD (1ch)","ICD (2ch)","CRTP","CRTD","S-ICD","Leadless PM"]);
    html += field("dv_manuf", "繝｡繝ｼ繧ｫ繝ｼ", d ? d.Manufacturer : "");
    html += field("dv_model", "繝｢繝・ΝNo", d ? d.ModelNumber : "");
    html += field("dv_serial", "繧ｷ繝ｪ繧｢繝ｫNo", d ? d.SerialNumber : "");
    html += field("dv_site", "驛ｨ菴・, d ? d.ImplantSite : "");
    html += "<div></div>"; // Placeholder
    html += "<div class='full-width'>" + field("dv_comment", "繧ｳ繝｡繝ｳ繝・, d ? d.GeneratorComment : "") + "</div>";
    html += "</div></div>";

    html += "<div class='detail-section-card'>";
    html += "<div class='detail-section-header lead-rv'>・コV lead諠・ｱ</div>";
    html += "<div class='detail-section-body'>";
    html += field("dv_rv_manuf", "繝｡繝ｼ繧ｫ繝ｼ", d ? d.RVLeadManufacturer : "");
    html += field("dv_rv_model", "繝｢繝・ΝNo", d ? d.RVLeadModel : "");
    html += field("dv_rv_len", "髟ｷ縺・cm)", d ? d.RVLeadLength : "");
    html += field("dv_rv_site", "驛ｨ菴・, d ? d.RVLeadSite : "");
    html += field("dv_rv_serial", "繧ｷ繝ｪ繧｢繝ｫNo", d ? d.RVLeadSerial : "");
    html += field("dv_rv_shock", "蠖｢迥ｶ", d ? d.RVLeadShockType : "", "select", ["-", "DF1/S", "DF1/D", "DF4/S", "DF4/D"]);
    html += "<div class='full-width'>" + field("dv_rv_comment", "繧ｳ繝｡繝ｳ繝・, d ? d.RVLeadComment : "") + "</div>";
    html += "</div></div>";
    html += "</div>"; // end column 2

    // Column 3: A Lead & LV Lead
    html += "<div class='detail-column'>";
    html += "<div class='detail-section-card'>";
    html += "<div class='detail-section-header lead-a'>・ア lead諠・ｱ</div>";
    html += "<div class='detail-section-body'>";
    html += field("dv_a_manuf", "繝｡繝ｼ繧ｫ繝ｼ", d ? d.ALeadManufacturer : "");
    html += field("dv_a_model", "繝｢繝・ΝNo", d ? d.ALeadModel : "");
    html += field("dv_a_len", "髟ｷ縺・cm)", d ? d.ALeadLength : "");
    html += field("dv_a_site", "驛ｨ菴・, d ? d.ALeadSite : "");
    html += field("dv_a_serial", "繧ｷ繝ｪ繧｢繝ｫNo", d ? d.ALeadSerial : "");
    html += "<div></div>"; // Placeholder
    html += "<div class='full-width'>" + field("dv_a_comment", "繧ｳ繝｡繝ｳ繝・, d ? d.ALeadComment : "") + "</div>";
    html += "</div></div>";

    html += "<div class='detail-section-card'>";
    html += "<div class='detail-section-header lead-lv'>・キV lead諠・ｱ</div>";
    html += "<div class='detail-section-body'>";
    html += field("dv_lv_manuf", "繝｡繝ｼ繧ｫ繝ｼ", d ? d.LVLeadManufacturer : "");
    html += field("dv_lv_model", "繝｢繝・ΝNo", d ? d.LVLeadModel : "");
    html += field("dv_lv_len", "髟ｷ縺・cm)", d ? d.LVLeadLength : "");
    html += field("dv_lv_site", "驛ｨ菴・, d ? d.LVLeadSite : "");
    html += field("dv_lv_serial", "繧ｷ繝ｪ繧｢繝ｫNo", d ? d.LVLeadSerial : "");
    html += field("dv_lv_port", "蠖｢迥ｶ", d ? d.LVLeadPortType : "", "select", ["-", "IS-1", "IS-4"]);
    html += "<div class='full-width'>" + field("dv_lv_comment", "繧ｳ繝｡繝ｳ繝・, d ? d.LVLeadComment : "") + "</div>";
    html += "</div></div>";
    html += "</div>"; // end column 3

    html += "</div>"; // end columns

    html += "</div>"; // end columns
    detailView.innerHTML = html;
}

function closeDeviceDetailPage() {
    document.getElementById("detail-view").style.display = "none";
    document.getElementById("brief-view").style.display = "block";
    gCurrentConfigID = null;
}

function saveDevice() {
    if (!gCurrentPID) return;
    if (!acquireLock()) { alert("莉悶・繝ｦ繝ｼ繧ｶ繝ｼ縺檎ｷｨ髮・ｸｭ縺ｧ縺吶・); return; }
    var excel = null; var book = null;
    try {
        excel = new ActiveXObject("Excel.Application");
        book = excel.Workbooks.Open(gDbPath);
        var sheet = book.Sheets("T_DeviceConfig");
        
        var fields = [
            "dv_implant_date", "dv_implant_hosp", 
            "dv_phys_p1", "dv_phys_p2", "dv_phys_p3",
            "dv_phys_o1", "dv_phys_o2", "dv_phys_o3",
            "dv_summary", "dv_type", "dv_manuf", "dv_model", "dv_serial", "dv_site", "dv_comment",
            "dv_a_manuf", "dv_a_model", "dv_a_len", "dv_a_site", "dv_a_serial", "dv_a_comment",
            "dv_rv_manuf", "dv_rv_model", "dv_rv_len", "dv_rv_site", "dv_rv_serial", "dv_rv_shock", "dv_rv_comment",
            "dv_lv_manuf", "dv_lv_model", "dv_lv_len", "dv_lv_site", "dv_lv_serial", "dv_lv_port", "dv_lv_comment"
        ];
        
        var targetRow = 0;
        if(gCurrentConfigID) {
            var rowCount = sheet.UsedRange.Rows.Count;
            for(var r=2; r<=rowCount; r++) {
                if(sheet.Cells(r, 1).Value == gCurrentConfigID) { targetRow = r; break; }
            }
        }
        
        if(targetRow == 0) {
            targetRow = sheet.UsedRange.Rows.Count + 1;
            sheet.Cells(targetRow, 1).Value = "C" + (new Date().getTime());
            sheet.Cells(targetRow, 2).Value = gCurrentPID;
            sheet.Cells(targetRow, 38).Value = "Active";
        }

        for(var i=0; i<fields.length; i++) {
            var val = document.getElementById(fields[i]).value;
            sheet.Cells(targetRow, i + 3).Value = val;
        }

        book.Save();
        book.Close();
        excel.Quit();
        releaseLock();
        alert("菫晏ｭ伜ｮ御ｺ・＠縺ｾ縺励◆縲・);
        loadAllData();
    } catch(e) {
        if(book) book.Close(false); if(excel) excel.Quit();
        releaseLock(); alert("菫晏ｭ倥お繝ｩ繝ｼ: " + e.message);
    }
}
function closeModal() { document.getElementById("modal-overlay").style.display = "none"; document.getElementById("modal-content").className = "modal-box"; }
function showSettingsModal() { alert("譛ｪ螳溯｣・); }
function showMeasurementModal() { alert("譛ｪ螳溯｣・); }

</script>
</head>
<body>
<div id="sidebar-panel">
    <div class="sidebar-header">
        <button id="btn-list" class="sidebar-tab active" onclick="showTab('list')">繝ｪ繧ｹ繝・/button>
        <button id="btn-info" class="sidebar-tab" onclick="showTab('info')">蝓ｺ譛ｬ諠・ｱ</button>
    </div>
    <div id="tab-list" class="sidebar-content active">
        <input type="text" class="search-box" id="search-box" onkeyup="filterList()" placeholder="讀懃ｴ｢...">
        <div id="status-msg" style="color:#fcd34d; font-size:12px; margin-bottom:5px;">Loading...</div>
        <div id="patient-list-container"></div>
        <div style="margin-top:20px; padding-top:20px; border-top:1px solid #334155;">
            <button class="btn btn-primary btn-block" onclick="showNewPatientModal()">・・譁ｰ隕乗ぅ閠・匳骭ｲ</button>
        </div>
    </div>
    <div id="tab-info" class="sidebar-content"><div id="patient-detail-container"></div></div>
</div>
<div id="main-panel">
    <div class="main-header">
        <div class="app-title"> CIEDs 謔｣閠・ｮ｡逅・す繧ｹ繝・Β <span id="loading-indicator" class="loader">騾壻ｿ｡荳ｭ...</span></div>
        <div id="current-patient-name" class="current-patient-name"></div>
    </div>
    <div id="brief-view" class="cards-area">
        <div class="card"><div class="card-header blue"><div class="card-title">繝・ヰ繧､繧ｹ諠・ｱ</div><button class="btn btn-secondary" onclick="showDeviceModal()">霑ｽ蜉</button></div><div class="card-body" id="device-body"></div></div>
        <div class="card"><div class="card-header green"><div class="card-title">險ｭ螳壽ュ蝣ｱ</div><button class="btn btn-secondary" onclick="showSettingsModal()">霑ｽ蜉</button></div><div class="card-body" id="settings-body"></div></div>
        <div class="card"><div class="card-header yellow"><div class="card-title">貂ｬ螳壽ュ蝣ｱ</div><button class="btn btn-secondary" onclick="showMeasurementModal()">霑ｽ蜉</button></div><div class="card-body" id="measurement-body"></div></div>
    </div>
    <div id="detail-view"></div>
</div>
<div id="modal-overlay" class="modal-overlay"><div id="modal-content" class="modal-box"></div></div>
</body>
</html>




